#!/bin/bash -e

# Include alternc function (and mysql)
. /usr/lib/alternc/functions.sh

CONFIGFILE="/etc/alternc/local.sh"

case "$1" in
	configure)
		printf "\tDisable apache mod_ssl\n"
		a2dismod --quiet ssl 1>/dev/null
		service apache2 restart

		printf "\tUpdate $CONFIGFILE configuration\n"

		# Add APACHE_SSL_DISABLED configuration
		grep -Eq "^ *APACHE_SSL_DISABLED=" $CONFIGFILE || echo "
	APACHE_SSL_DISABLED=yes" >> $CONFIGFILE

		# Force APACHE_SSL_DISABLED configuration
		sed -i -e 's# *APACHE_SSL_DISABLED=.*#APACHE_SSL_DISABLED=yes#' $CONFIGFILE

		## Disable nginx server default if it tries to listen on http port
		if [ -h /etc/nginx/sites-enabled/default ] && grep -qP '\s*listen\s*80[^\d]' /etc/nginx/sites-available/default
		then
			printf "\tDisable default server listening on http port\n"
			rm /etc/nginx/sites-enabled/default
		fi

		## Force AlternC panel to use only https
		mysql_query 'UPDATE variable SET value=1 WHERE name = "force_https"'
	;;

esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.
#DEBHELPER#
